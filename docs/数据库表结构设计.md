# 河南麻将数据库表结构设计

## 1. 数据库概述

### 1.1 数据库信息
- **数据库名称**: `mahjong_db`
- **字符集**: `utf8mb4`
- **排序规则**: `utf8mb4_unicode_ci`
- **存储引擎**: `InnoDB`

### 1.2 表设计原则
- 遵循第三范式，避免数据冗余
- 使用合适的数据类型减少存储空间
- 添加必要的索引提高查询性能
- 使用外键保证数据完整性
- 添加创建时间和更新时间字段

## 2. 核心表结构

### 2.1 房间表 (rooms)
```sql
CREATE TABLE rooms (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '房间ID',
    room_number VARCHAR(8) NOT NULL UNIQUE COMMENT '房间号',
    room_name VARCHAR(50) DEFAULT '' COMMENT '房间名称',
    creator_id VARCHAR(36) NOT NULL COMMENT '创建者ID',
    max_players TINYINT DEFAULT 4 COMMENT '最大玩家数',
    current_players TINYINT DEFAULT 0 COMMENT '当前玩家数',
    room_status ENUM('WAITING', 'PLAYING', 'FINISHED') DEFAULT 'WAITING' COMMENT '房间状态',
    game_config JSON COMMENT '游戏配置',
    allow_spectate BOOLEAN DEFAULT TRUE COMMENT '是否允许观战',
    spectator_count TINYINT DEFAULT 0 COMMENT '观战人数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    expires_at TIMESTAMP NULL COMMENT '过期时间',

    INDEX idx_room_number (room_number),
    INDEX idx_creator_id (creator_id),
    INDEX idx_room_status (room_status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='房间信息表';
```

### 2.2 玩家表 (players)
```sql
CREATE TABLE players (
    id VARCHAR(36) PRIMARY KEY COMMENT '玩家唯一标识',
    room_id BIGINT NOT NULL COMMENT '所属房间ID',
    player_name VARCHAR(20) NOT NULL COMMENT '玩家昵称',
    player_avatar VARCHAR(200) DEFAULT '' COMMENT '玩家头像URL',
    player_position TINYINT NOT NULL COMMENT '玩家位置(1-4)',
    player_status ENUM('ONLINE', 'OFFLINE', 'READY', 'PLAYING') DEFAULT 'ONLINE' COMMENT '玩家状态',
    spectator BOOLEAN DEFAULT FALSE COMMENT '是否为观战者',
    total_score INT DEFAULT 0 COMMENT '总分数',
    wins_count INT DEFAULT 0 COMMENT '获胜次数',
    ready_at TIMESTAMP NULL COMMENT '准备时间',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
    last_active_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后活跃时间',

    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE,
    UNIQUE KEY uk_room_position (room_id, player_position),
    INDEX idx_room_id (room_id),
    INDEX idx_player_name (player_name),
    INDEX idx_player_status (player_status),
    INDEX idx_last_active_at (last_active_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='玩家信息表';
```

### 2.3 游戏表 (games)
```sql
CREATE TABLE games (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '游戏ID',
    room_id BIGINT NOT NULL COMMENT '所属房间ID',
    game_number INT NOT NULL COMMENT '游戏局数',
    game_status ENUM('PREPARING', 'PLAYING', 'FINISHED') DEFAULT 'PREPARING' COMMENT '游戏状态',
    current_player_id VARCHAR(36) COMMENT '当前出牌玩家ID',
    current_round TINYINT DEFAULT 1 COMMENT '当前回合数',
    wall_tiles JSON COMMENT '牌墙信息',
    draw_pile JSON COMMENT '摸牌堆信息',
    discard_pile JSON COMMENT '弃牌堆信息',
    dealer_id VARCHAR(36) COMMENT '庄家ID',
    dealer_position TINYINT COMMENT '庄家位置',
    wind_direction ENUM('EAST', 'SOUTH', 'WEST', 'NORTH') DEFAULT 'EAST' COMMENT '当前风位',
    mixed_tile VARCHAR(10) COMMENT '混牌标识',
    round_number TINYINT DEFAULT 1 COMMENT '圈数',
    hand_number TINYINT DEFAULT 1 COMMENT '手数',
    game_result JSON COMMENT '游戏结果',
    started_at TIMESTAMP NULL COMMENT '开始时间',
    finished_at TIMESTAMP NULL COMMENT '结束时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE,
    UNIQUE KEY uk_room_game (room_id, game_number),
    INDEX idx_room_id (room_id),
    INDEX idx_game_status (game_status),
    INDEX idx_started_at (started_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='游戏记录表';
```

### 2.4 玩家手牌表 (player_hands)
```sql
CREATE TABLE player_hands (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '手牌ID',
    game_id BIGINT NOT NULL COMMENT '游戏ID',
    player_id VARCHAR(36) NOT NULL COMMENT '玩家ID',
    hand_tiles JSON NOT NULL COMMENT '手牌信息',
    draw_count TINYINT DEFAULT 0 COMMENT '摸牌次数',
    discard_count TINYINT DEFAULT 0 COMMENT '出牌次数',
    claim_count TINYINT DEFAULT 0 COMMENT '吃碰杠次数',
    score INT DEFAULT 0 COMMENT '本局得分',
    winner BOOLEAN DEFAULT FALSE COMMENT '是否获胜',
    win_type ENUM('SELF_DRAWN', 'DISCARD', 'KONG', 'ROB') COMMENT '胡牌类型',
    winning_tiles JSON COMMENT '胡牌组合',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE,
    FOREIGN KEY (player_id) REFERENCES players(id) ON DELETE CASCADE,
    UNIQUE KEY uk_game_player (game_id, player_id),
    INDEX idx_game_id (game_id),
    INDEX idx_player_id (player_id),
    INDEX idx_score (score)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='玩家手牌表';
```

### 2.5 游戏操作记录表 (game_actions)
```sql
CREATE TABLE game_actions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '操作ID',
    game_id BIGINT NOT NULL COMMENT '游戏ID',
    player_id VARCHAR(36) NOT NULL COMMENT '玩家ID',
    action_type ENUM('DRAW', 'DISCARD', 'PENG', 'GANG', 'CHI', 'HU', 'PASS') NOT NULL COMMENT '操作类型',
    action_data JSON COMMENT '操作详情',
    tile_info VARCHAR(20) COMMENT '相关牌信息',
    action_order INT NOT NULL COMMENT '操作顺序',
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',

    FOREIGN KEY (game_id) REFERENCES games(id) ON DELETE CASCADE,
    FOREIGN KEY (player_id) REFERENCES players(id) ON DELETE CASCADE,
    INDEX idx_game_id (game_id),
    INDEX idx_player_id (player_id),
    INDEX idx_action_type (action_type),
    INDEX idx_timestamp (timestamp),
    INDEX idx_action_order (game_id, action_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='游戏操作记录表';
```

### 2.6 游戏配置表 (game_configs)
```sql
CREATE TABLE game_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '配置ID',
    config_name VARCHAR(50) NOT NULL COMMENT '配置名称',
    base_score TINYINT DEFAULT 1 COMMENT '基础分',
    max_rounds TINYINT DEFAULT 8 COMMENT '最大局数',
    allow_peng BOOLEAN DEFAULT TRUE COMMENT '允许碰',
    allow_gang BOOLEAN DEFAULT TRUE COMMENT '允许杠',
    allow_chi BOOLEAN DEFAULT FALSE COMMENT '允许吃(河南麻将不允许)',
    require_tiles BOOLEAN DEFAULT TRUE COMMENT '是否必须达到规定胡牌番数',
    mixed_tile_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用混牌',
    auto_discard BOOLEAN DEFAULT FALSE COMMENT '自动出牌',
    think_time INT DEFAULT 30 COMMENT '思考时间(秒)',
    score_rules JSON COMMENT '计分规则',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    UNIQUE KEY uk_config_name (config_name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='游戏配置表';
```

## 3. 系统表结构

### 3.1 聊天消息表 (chat_messages)
```sql
CREATE TABLE chat_messages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '消息ID',
    room_id BIGINT NOT NULL COMMENT '房间ID',
    player_id VARCHAR(36) COMMENT '发送者ID(系统消息为空)',
    message_type ENUM('TEXT', 'EMOJI', 'SYSTEM') DEFAULT 'TEXT' COMMENT '消息类型',
    message_content TEXT NOT NULL COMMENT '消息内容',
    player_name VARCHAR(20) COMMENT '发送者名称',
    deleted BOOLEAN DEFAULT FALSE COMMENT '是否已删除',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE,
    INDEX idx_room_id (room_id),
    INDEX idx_player_id (player_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='聊天消息表';
```

### 3.2 游戏统计表 (game_statistics)
```sql
CREATE TABLE game_statistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '统计ID',
    room_id BIGINT NOT NULL COMMENT '房间ID',
    player_id VARCHAR(36) NOT NULL COMMENT '玩家ID',
    total_games INT DEFAULT 0 COMMENT '总游戏局数',
    total_wins INT DEFAULT 0 COMMENT '总获胜局数',
    total_score INT DEFAULT 0 COMMENT '总得分',
    max_score INT DEFAULT 0 COMMENT '最高得分',
    min_score INT DEFAULT 0 COMMENT '最低得分',
    avg_score DECIMAL(8,2) DEFAULT 0 COMMENT '平均得分',
    total_peng_count INT DEFAULT 0 COMMENT '总碰牌次数',
    total_gang_count INT DEFAULT 0 COMMENT '总杠牌次数',
    total_hu_count INT DEFAULT 0 COMMENT '总胡牌次数',
    win_rate DECIMAL(5,2) DEFAULT 0 COMMENT '胜率(%)',
    last_played_at TIMESTAMP NULL COMMENT '最后游戏时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE,
    FOREIGN KEY (player_id) REFERENCES players(id) ON DELETE CASCADE,
    UNIQUE KEY uk_room_player (room_id, player_id),
    INDEX idx_player_id (player_id),
    INDEX idx_win_rate (win_rate)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='游戏统计表';
```

### 3.3 系统日志表 (system_logs)
```sql
CREATE TABLE system_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    log_level ENUM('DEBUG', 'INFO', 'WARN', 'ERROR') DEFAULT 'INFO' COMMENT '日志级别',
    module_name VARCHAR(50) NOT NULL COMMENT '模块名称',
    operation_type VARCHAR(50) COMMENT '操作类型',
    player_id VARCHAR(36) COMMENT '相关玩家ID',
    room_id BIGINT COMMENT '相关房间ID',
    game_id BIGINT COMMENT '相关游戏ID',
    log_message TEXT NOT NULL COMMENT '日志消息',
    exception_info TEXT COMMENT '异常信息',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    INDEX idx_log_level (log_level),
    INDEX idx_module_name (module_name),
    INDEX idx_player_id (player_id),
    INDEX idx_room_id (room_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统日志表';
```

### 3.4 在线用户表 (online_users)
```sql
CREATE TABLE online_users (
    id VARCHAR(36) PRIMARY KEY COMMENT '用户ID',
    room_id BIGINT COMMENT '当前房间ID',
    player_name VARCHAR(20) NOT NULL COMMENT '玩家昵称',
    connection_id VARCHAR(100) NOT NULL COMMENT 'WebSocket连接ID',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    spectator BOOLEAN DEFAULT FALSE COMMENT '是否观战者',
    last_heartbeat TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '最后心跳时间',
    connected_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '连接时间',

    FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE SET NULL,
    INDEX idx_room_id (room_id),
    INDEX idx_connection_id (connection_id),
    INDEX idx_last_heartbeat (last_heartbeat)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='在线用户表';
```

## 4. 视图定义

### 4.1 房间详情视图
```sql
CREATE VIEW room_details AS
SELECT
    r.id,
    r.room_number,
    r.room_name,
    r.creator_id,
    r.max_players,
    r.current_players,
    r.room_status,
    r.allow_spectate,
    r.spectator_count,
    r.created_at,
    r.updated_at,
    (SELECT COUNT(*) FROM players p WHERE p.room_id = r.id AND p.spectator = FALSE) as actual_players,
    (SELECT COUNT(*) FROM players p WHERE p.room_id = r.id AND p.spectator = TRUE) as actual_spectators,
    (SELECT COUNT(*) FROM players p WHERE p.room_id = r.id AND p.player_status = 'READY') as ready_players
FROM rooms r;
```

### 4.2 游戏统计视图
```sql
CREATE VIEW player_game_stats AS
SELECT
    p.id as player_id,
    p.player_name,
    p.room_id,
    COUNT(DISTINCT g.id) as total_games,
    COUNT(DISTINCT CASE WHEN ph.winner = TRUE THEN g.id END) as total_wins,
    COALESCE(SUM(ph.score), 0) as total_score,
    COALESCE(MAX(ph.score), 0) as max_score,
    COALESCE(MIN(ph.score), 0) as min_score,
    COALESCE(AVG(ph.score), 0) as avg_score,
    CASE
        WHEN COUNT(DISTINCT g.id) > 0
        THEN ROUND(COUNT(DISTINCT CASE WHEN ph.winner = TRUE THEN g.id END) * 100.0 / COUNT(DISTINCT g.id), 2)
        ELSE 0
    END as win_rate
FROM players p
LEFT JOIN games g ON p.room_id = g.room_id
LEFT JOIN player_hands ph ON g.id = ph.game_id AND p.id = ph.player_id
GROUP BY p.id, p.player_name, p.room_id;
```

## 5. 索引优化

### 5.1 复合索引
```sql
-- 游戏操作查询优化
CREATE INDEX idx_game_player_actions ON game_actions(game_id, player_id, action_order);

-- 玩家状态查询优化
CREATE INDEX idx_room_player_status ON players(room_id, player_status, spectator);

-- 时间范围查询优化
CREATE INDEX idx_games_time_range ON games(room_id, started_at, finished_at);

-- 聊天消息分页查询优化
CREATE INDEX idx_chat_pagination ON chat_messages(room_id, created_at DESC);
```

### 5.2 全文索引
```sql
-- 玩家名称搜索
ALTER TABLE players ADD FULLTEXT INDEX ft_player_name (player_name);

-- 聊天消息搜索
ALTER TABLE chat_messages ADD FULLTEXT INDEX ft_message_content (message_content);
```

## 6. 存储过程

### 6.1 创建房间存储过程
```sql
DELIMITER //
CREATE PROCEDURE CreateRoom(
    IN p_room_name VARCHAR(50),
    IN p_creator_id VARCHAR(36),
    IN p_config_id BIGINT,
    OUT p_room_id BIGINT,
    OUT p_room_number VARCHAR(8)
)
BEGIN
    DECLARE v_room_number VARCHAR(8);
    DECLARE v_max_players TINYINT DEFAULT 4;
    DECLARE v_game_config JSON;

    -- 生成唯一房间号
    REPEAT
        SET v_room_number = LPAD(FLOOR(RAND() * 10000000), 7, '0');
    END WHILE EXISTS (SELECT 1 FROM rooms WHERE room_number = v_room_number);

    -- 获取游戏配置
    SELECT JSON_OBJECT(
        'base_score', base_score,
        'max_rounds', max_rounds,
        'allow_peng', allow_peng,
        'allow_gang', allow_gang,
        'mixed_tile_enabled', mixed_tile_enabled
    ) INTO v_game_config
    FROM game_configs WHERE id = p_config_id;

    -- 创建房间
    INSERT INTO rooms (
        room_number, room_name, creator_id, max_players,
        game_config, created_at
    ) VALUES (
        v_room_number, p_room_name, p_creator_id, v_max_players,
        v_game_config, NOW()
    );

    SET p_room_id = LAST_INSERT_ID();
    SET p_room_number = v_room_number;
END //
DELIMITER ;
```

### 6.2 更新游戏统计存储过程
```sql
DELIMITER //
CREATE PROCEDURE UpdateGameStatistics(
    IN p_room_id BIGINT,
    IN p_player_id VARCHAR(36),
    IN p_game_score INT,
    IN p_winner BOOLEAN
)
BEGIN
    INSERT INTO game_statistics (
        room_id, player_id, total_games, total_wins,
        total_score, max_score, min_score, avg_score,
        last_played_at, updated_at
    ) VALUES (
        p_room_id, p_player_id, 1, IF(p_winner, 1, 0),
        p_game_score, p_game_score, p_game_score, p_game_score,
        NOW(), NOW()
    )
    ON DUPLICATE KEY UPDATE
        total_games = total_games + 1,
        total_wins = total_wins + IF(p_winner, 1, 0),
        total_score = total_score + p_game_score,
        max_score = GREATEST(max_score, p_game_score),
        min_score = LEAST(min_score, p_game_score),
        avg_score = total_score / total_games,
        win_rate = ROUND(total_wins * 100.0 / total_games, 2),
        last_played_at = NOW(),
        updated_at = NOW();
END //
DELIMITER ;
```

## 7. 触发器

### 7.1 房间状态更新触发器
```sql
DELIMITER //
CREATE TRIGGER tr_room_status_update
AFTER UPDATE ON rooms
FOR EACH ROW
BEGIN
    -- 如果房间状态变为游戏中，记录日志
    IF OLD.room_status != 'PLAYING' AND NEW.room_status = 'PLAYING' THEN
        INSERT INTO system_logs (
            log_level, module_name, operation_type,
            room_id, log_message, created_at
        ) VALUES (
            'INFO', 'ROOM', 'STATUS_CHANGE',
            NEW.id, CONCAT('房间 ', NEW.room_number, ' 开始游戏'), NOW()
        );
    END IF;

    -- 如果房间状态变为结束，清理在线用户
    IF OLD.room_status != 'FINISHED' AND NEW.room_status = 'FINISHED' THEN
        DELETE FROM online_users WHERE room_id = NEW.id;
    END IF;
END //
DELIMITER ;
```

### 7.2 玩家加入离开触发器
```sql
DELIMITER //
CREATE TRIGGER tr_player_join
AFTER INSERT ON players
FOR EACH ROW
BEGIN
    -- 更新房间当前人数
    UPDATE rooms
    SET current_players = (
        SELECT COUNT(*) FROM players
        WHERE room_id = NEW.room_id AND spectator = FALSE
    ),
    spectator_count = (
        SELECT COUNT(*) FROM players
        WHERE room_id = NEW.room_id AND spectator = TRUE
    ),
    updated_at = NOW()
    WHERE id = NEW.room_id;

    -- 记录系统日志
    INSERT INTO system_logs (
        log_level, module_name, operation_type,
        player_id, room_id, log_message, created_at
    ) VALUES (
        'INFO', 'PLAYER', 'JOIN',
        NEW.id, NEW.room_id,
        CONCAT('玩家 ', NEW.player_name, ' 加入房间'), NOW()
    );
END //
DELIMITER ;

DELIMITER //
CREATE TRIGGER tr_player_leave
AFTER DELETE ON players
FOR EACH ROW
BEGIN
    -- 更新房间当前人数
    UPDATE rooms
    SET current_players = (
        SELECT COUNT(*) FROM players
        WHERE room_id = OLD.room_id AND spectator = FALSE
    ),
    spectator_count = (
        SELECT COUNT(*) FROM players
        WHERE room_id = OLD.room_id AND spectator = TRUE
    ),
    updated_at = NOW()
    WHERE id = OLD.room_id;

    -- 记录系统日志
    INSERT INTO system_logs (
        log_level, module_name, operation_type,
        player_id, room_id, log_message, created_at
    ) VALUES (
        'INFO', 'PLAYER', 'LEAVE',
        OLD.id, OLD.room_id,
        CONCAT('玩家 ', OLD.player_name, ' 离开房间'), NOW()
    );
END //
DELIMITER ;
```

## 8. 初始化数据

### 8.1 游戏配置初始化
```sql
-- 标准配置
INSERT INTO game_configs (config_name, base_score, max_rounds, allow_peng, allow_gang, allow_chi, require_tiles, mixed_tile_enabled, think_time, score_rules) VALUES
('标准配置', 1, 8, TRUE, TRUE, FALSE, FALSE, TRUE, 30, JSON_OBJECT(
    'base_score', 1,
    'peng_score', 1,
    'gang_score', 2,
    'hu_score', 8,
    'self_drawn_bonus', 1,
    'mixed_tile_bonus', 2
)),
('快速配置', 1, 4, TRUE, TRUE, FALSE, FALSE, TRUE, 15, JSON_OBJECT(
    'base_score', 1,
    'peng_score', 1,
    'gang_score', 2,
    'hu_score', 4,
    'self_drawn_bonus', 1,
    'mixed_tile_bonus', 1
)),
('竞技配置', 2, 16, TRUE, TRUE, FALSE, TRUE, TRUE, 60, JSON_OBJECT(
    'base_score', 2,
    'peng_score', 2,
    'gang_score', 4,
    'hu_score', 16,
    'self_drawn_bonus', 2,
    'mixed_tile_bonus', 4
));
```

### 8.2 清理过期数据存储过程
```sql
DELIMITER //
CREATE PROCEDURE CleanupExpiredData()
BEGIN
    -- 清理7天前的游戏记录
    DELETE FROM games WHERE created_at < DATE_SUB(NOW(), INTERVAL 7 DAY);

    -- 清理30天前的聊天记录
    DELETE FROM chat_messages WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);

    -- 清理30天前的系统日志
    DELETE FROM system_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);

    -- 清理过期的房间
    DELETE FROM rooms WHERE expires_at IS NOT NULL AND expires_at < NOW();

    -- 清理离线用户
    DELETE FROM online_users WHERE last_heartbeat < DATE_SUB(NOW(), INTERVAL 5 MINUTE);
END //
DELIMITER ;

-- 创建定时任务事件（MySQL 5.1.6+）
CREATE EVENT IF NOT EXISTS cleanup_event
ON SCHEDULE EVERY 1 HOUR
DO CALL CleanupExpiredData();
```

## 9. 备份和恢复

### 9.1 数据备份策略
```sql
-- 全量备份脚本示例
mysqldump -u root -p --single-transaction --routines --triggers mahjong_db > backup_full_$(date +%Y%m%d_%H%M%S).sql

-- 增量备份（基于binlog）
mysqlbinlog --start-datetime="2024-01-01 00:00:00" --stop-datetime="2024-01-01 23:59:59" /var/lib/mysql/mysql-bin.000001 > backup_incremental.sql
```

### 9.2 数据恢复
```sql
-- 全量恢复
mysql -u root -p mahjong_db < backup_full_20240101_120000.sql

-- 增量恢复
mysql -u root -p mahjong_db < backup_incremental.sql
```

## 10. 性能优化建议

### 10.1 查询优化
- 合理使用索引，避免全表扫描
- 使用EXPLAIN分析查询执行计划
- 对于大数据量表考虑分库分表
- 使用读写分离减少主库压力

### 10.2 存储优化
- 选择合适的数据类型减少存储空间
- 对于JSON字段使用专门的功能进行查询
- 定期清理历史数据避免表过大
- 考虑使用Redis缓存热点数据

### 10.3 连接优化
- 配置合适的数据库连接池大小
- 使用连接池监控工具监控连接状态
- 设置合理的超时时间避免连接泄漏
- 在高并发场景下考虑数据库集群